pipeline {
  agent {
      any {
           image 'maven:3.6.0-jdk-8-alpine'
           reuseNode true
      }
  }
   stages {
    stage('Build and Test') {
       steps {
        
            sh '/var/jenkins_home/tools/hudson.tasks.Maven_MavenInstallation/Maven3/bin/mvn clean install'
            junit '**/surefire-reports/*.xml'
        
       }
    }
    stage('Publish Artifacts') {
      when {
        anyOf {
              branch 'master'
              branch 'develop'
            }
        }
        steps {
          
            sh '/var/jenkins_home/tools/hudson.tasks.Maven_MavenInstallation/Maven3/bin/mvn deploy -DskipTests'
          
        }
      }
      stage('Continuous SonarQube Analysis') {
       when {
          anyOf {
                branch 'master'
                branch 'develop'
              }
          }
          steps {
            
             
                sh "/var/jenkins_home/tools/hudson.tasks.Maven_MavenInstallation/Maven3/bin/mvn org.owasp:dependency-check-maven:aggregate sonar:sonar ${persistedSonarAnalysisOptions()}"
              
            
          }
      }
      stage('SonarQube-Reviewer') {
          when {
              anyOf {
                  changeRequest()
              }
          }
          steps {
              withSonarQubeEnv('ec2-3-16-157-114.us-east-2.compute.amazonaws.com') {
                withCredentials(sonarReviewer()) {
                 
                     sh "/var/jenkins_home/tools/hudson.tasks.Maven_MavenInstallation/Maven3/bin/mvn sonar:sonar ${passthroughSonarAnalysisOptions()}"
                  
              }
           }
        }
     }
  }
  post {
    changed {
      email isMainlineBranch() ? leadDeveloper() : nobody()
    }
    regression {
      email isChangeRequest() ? committers() : nobody()
    }
    success {
      email isChangeRequest() ? committers() : nobody()
    }
  }
}
